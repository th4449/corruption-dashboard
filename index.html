<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corruption Tracker Pro - Advanced Government Transparency Platform</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json,{
        'name': 'Corruption Tracker Pro',
        'short_name': 'CorruptionTracker',
        'description': 'Advanced Government Transparency and Corruption Monitoring Platform',
        'start_url': '/',
        'display': 'standalone',
        'background_color': '#1a1a2e',
        'theme_color': '#3498db',
        'icons': [
            {
                'src': 'data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><circle cx=\"50\" cy=\"50\" r=\"45\" fill=\"%233498db\"/><text x=\"50\" y=\"55\" text-anchor=\"middle\" fill=\"white\" font-size=\"30\" font-family=\"Arial\">üèõ</text></svg>',
                'sizes': '192x192',
                'type': 'image/svg+xml'
            }
        ]
    }">
    
    <!-- Meta Tags -->
    <meta name="description" content="Professional corruption tracking dashboard with AI-powered analytics, network mapping, and real-time government transparency monitoring across all US jurisdictions.">
    <meta name="keywords" content="corruption tracking, government transparency, political analysis, campaign finance, public integrity">
    <meta name="author" content="Corruption Tracker Pro">
    
    <!-- External Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.4/dexie.min.js"></script>
    
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --dark-bg: #1a1a2e;
            --medium-bg: #16213e;
            --light-bg: #0f3460;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --border-radius: 20px;
            --shadow-light: 0 10px 25px rgba(0, 0, 0, 0.1);
            --shadow-heavy: 0 25px 50px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--dark-bg) 0%, var(--medium-bg) 50%, var(--light-bg) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--dark-bg), var(--medium-bg));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-logo {
            font-size: 4rem;
            margin-bottom: 2rem;
            animation: pulse 2s infinite;
        }

        .loading-text {
            color: white;
            font-size: 1.5rem;
            margin-bottom: 2rem;
        }

        .loading-progress {
            width: 300px;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
            width: 0%;
            transition: width 0.3s ease;
            animation: shimmer 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: 200px 0; }
        }

        /* Main Layout */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            opacity: 0;
            transform: translateY(20px);
            transition: var(--transition);
        }

        .container.loaded {
            opacity: 1;
            transform: translateY(0);
        }

        /* Header */
        .header {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border-radius: var(--border-radius);
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-heavy);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-color), var(--warning-color), #f1c40f, var(--success-color), var(--primary-color), #9b59b6);
        }

        .header h1 {
            font-size: clamp(2rem, 5vw, 3rem);
            background: linear-gradient(135deg, var(--secondary-color), #34495e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .header p {
            color: var(--text-secondary);
            font-size: clamp(1rem, 2vw, 1.2rem);
            margin-bottom: 20px;
        }

        .header-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .header-stat {
            text-align: center;
        }

        .header-stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--secondary-color);
        }

        .header-stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Status Bar */
        .status-bar {
            background: var(--glass-bg);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: var(--shadow-light);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-indicator.online {
            background: var(--success-color);
        }

        .status-indicator.offline {
            background: var(--danger-color);
        }

        .status-indicator.syncing {
            background: var(--warning-color);
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: var(--glass-bg);
            border-radius: var(--border-radius);
            padding: 5px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-light);
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            min-width: 120px;
            padding: 15px 20px;
            border: none;
            background: transparent;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            transition: var(--transition);
            white-space: nowrap;
        }

        .tab.active {
            background: linear-gradient(135deg, var(--primary-color), #2980b9);
            color: white;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .tab:hover:not(.active) {
            background: rgba(52, 152, 219, 0.1);
            color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Controls */
        .controls {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            box-shadow: var(--shadow-light);
        }

        .btn {
            background: linear-gradient(135deg, var(--primary-color), #2980b9);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 25px rgba(52, 152, 219, 0.4);
        }

        .btn.primary {
            background: linear-gradient(135deg, var(--accent-color), #c0392b);
        }

        .btn.primary:hover {
            box-shadow: 0 15px 25px rgba(231, 76, 60, 0.4);
        }

        .btn.success {
            background: linear-gradient(135deg, var(--success-color), #229954);
        }

        .btn.warning {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-loading::after {
            content: '';
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .filter-select {
            background: white;
            border: 2px solid #ecf0f1;
            padding: 12px 18px;
            border-radius: 25px;
            outline: none;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .filter-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--shadow-heavy);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), #2980b9);
        }

        .card:hover {
            transform: translateY(-10px);
            box-shadow: 0 35px 70px rgba(0, 0, 0, 0.15);
        }

        .card h2 {
            color: var(--secondary-color);
            margin-bottom: 25px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--glass-bg);
            border-radius: var(--border-radius);
            padding: 25px;
            text-align: center;
            box-shadow: var(--shadow-light);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-color), var(--warning-color));
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--secondary-color), #34495e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        /* Stories */
        .story-item {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid;
            transition: var(--transition);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .story-item::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: rgba(52, 152, 219, 0.1);
            transition: var(--transition);
        }

        .story-item:hover {
            transform: translateX(8px);
            box-shadow: var(--shadow-light);
        }

        .story-item:hover::before {
            width: 100%;
        }

        .story-item.high {
            border-left-color: var(--danger-color);
        }

        .story-item.medium {
            border-left-color: var(--warning-color);
        }

        .story-item.low {
            border-left-color: var(--success-color);
        }

        .story-title {
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--secondary-color);
            font-size: 1.1rem;
            line-height: 1.4;
        }

        .story-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .story-summary {
            font-size: 0.95rem;
            color: #555;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .story-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .story-tag {
            background: linear-gradient(135deg, #ecf0f1, #bdc3c7);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--secondary-color);
        }

        .story-amount {
            background: linear-gradient(135deg, var(--primary-color), #2980b9);
            color: white;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            display: inline-block;
        }

        /* Messages */
        .loading {
            text-align: center;
            padding: 60px;
            color: var(--text-secondary);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #ecf0f1;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
        }

        .error-message {
            background: linear-gradient(135deg, #fadbd8, #f1948a);
            color: #c0392b;
            padding: 15px 20px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 4px solid var(--danger-color);
            font-weight: 600;
        }

        .success-message {
            background: linear-gradient(135deg, #d5f4e6, #a9dfbf);
            color: var(--success-color);
            padding: 15px 20px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 4px solid var(--success-color);
            font-weight: 600;
        }

        .warning-message {
            background: linear-gradient(135deg, #fef9e7, #fcf3cf);
            color: #b7950b;
            padding: 15px 20px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 4px solid var(--warning-color);
            font-weight: 600;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 350px;
            margin-top: 25px;
        }

        /* Network Graph */
        .network-graph {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--shadow-light);
            min-height: 400px;
        }

        .network-node {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: var(--shadow-light);
            cursor: pointer;
            transition: var(--transition);
        }

        .network-node:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-heavy);
        }

        /* Heatmap */
        .heatmap-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--shadow-light);
        }

        .state-cell {
            display: inline-block;
            width: 30px;
            height: 20px;
            margin: 1px;
            border-radius: 3px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .state-cell:hover {
            transform: scale(1.2);
            z-index: 10;
        }

        /* Newsletter Builder */
        .newsletter-builder {
            background: var(--glass-bg);
            border-radius: var(--border-radius);
            padding: 30px;
            margin-top: 30px;
            box-shadow: var(--shadow-heavy);
            position: relative;
            overflow: hidden;
        }

        .newsletter-builder::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #e67e22, #d35400);
        }

        .newsletter-content {
            border: 3px dashed #bdc3c7;
            border-radius: 15px;
            padding: 30px;
            min-height: 250px;
            margin-bottom: 25px;
            transition: var(--transition);
        }

        .newsletter-content.dragover {
            border-color: var(--primary-color);
            background: rgba(52, 152, 219, 0.05);
        }

        .newsletter-item {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
            transition: var(--transition);
        }

        .newsletter-item:hover {
            transform: translateX(5px);
        }

        /* Configuration Panel */
        .config-panel {
            background: var(--glass-bg);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-light);
        }

        .config-section {
            margin-bottom: 25px;
        }

        .config-section h3 {
            color: var(--secondary-color);
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .config-item:last-child {
            border-bottom: none;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .tabs {
                overflow-x: auto;
            }
            
            .tab {
                min-width: 100px;
                padding: 12px 16px;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .story-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .container {
                padding: 10px;
            }
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
                color: black;
            }
            
            .tabs, .controls, .btn {
                display: none;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
                break-inside: avoid;
            }
        }

        /* Dark Theme Support */
        @media (prefers-color-scheme: dark) {
            :root {
                --glass-bg: rgba(30, 30, 30, 0.95);
                --text-primary: #ffffff;
                --text-secondary: #b0b0b0;
            }
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1000;
        }

        /* AI Insights */
        .ai-insights {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-heavy);
        }

        .ai-insights h3 {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .prediction-box {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            backdrop-filter: blur(10px);
        }

        .risk-indicator {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin: 0 5px;
        }

        .risk-high {
            background: var(--danger-color);
            color: white;
        }

        .risk-medium {
            background: var(--warning-color);
            color: white;
        }

        .risk-low {
            background: var(--success-color);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">üèõ</div>
        <div class="loading-text">Initializing Corruption Tracker Pro</div>
        <div class="loading-progress">
            <div class="loading-progress-bar" id="loadingBar"></div>
        </div>
    </div>

    <div class="container" id="mainContainer">
        <!-- Header -->
        <div class="header">
            <h1>üèõ Corruption Tracker Pro</h1>
            <p>Advanced Government Transparency Platform with AI-Powered Analytics & Real-Time Monitoring</p>
            <div class="header-stats">
                <div class="header-stat">
                    <div class="header-stat-number" id="headerTotalSources">150+</div>
                    <div class="header-stat-label">Data Sources</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-number" id="headerStoriesCount">0</div>
                    <div class="header-stat-label">Stories Tracked</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-number" id="headerStatesCount">50</div>
                    <div class="header-stat-label">States Covered</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-number" id="headerLastUpdate">Never</div>
                    <div class="header-stat-label">Last Update</div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator" id="systemStatus"></div>
                <span id="systemStatusText">System Status</span>
            </div>
            <div class="status-item">
                <div class="status-indicator" id="dataStatus"></div>
                <span id="dataStatusText">Data Sources</span>
            </div>
            <div class="status-item">
                <div class="status-indicator" id="networkStatus"></div>
                <span id="networkStatusText">Network</span>
            </div>
            <div class="status-item">
                <span id="cacheInfo">Cache: 0 MB</span>
            </div>
            <div class="status-item">
                <span id="versionInfo">v2.0.0</span>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')" data-tooltip="Main corruption monitoring dashboard">
                üìä Dashboard
            </button>
            <button class="tab" onclick="showTab('analytics')" data-tooltip="AI-powered corruption analytics">
                üîç AI Analytics
            </button>
            <button class="tab" onclick="showTab('network')" data-tooltip="Political network mapping">
                üï∏ Network Map
            </button>
            <button class="tab" onclick="showTab('newsletter')" data-tooltip="Professional newsletter builder">
                üìß Newsletter
            </button>
            <button class="tab" onclick="showTab('data')" data-tooltip="Data management and export">
                üíæ Data Manager
            </button>
            <button class="tab" onclick="showTab('settings')" data-tooltip="System configuration">
                ‚öôÔ∏è Settings
            </button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="controls">
                <button id="pullBtn" class="btn primary" data-tooltip="Fetch corruption stories from all sources">
                    üîÑ Pull All Data Sources
                </button>
                <select id="feedFilter" class="filter-select">
                    <option value="*">All Types</option>
                    <option value="news">üì∞ News / Watchdog</option>
                    <option value="contract">üìÑ Gov Contracts</option>
                    <option value="finance">üí∞ Campaign Finance</option>
                    <option value="lobby">ü§ù Lobbying</option>
                    <option value="index">üìä Risk Index</option>
                </select>
                <select id="stateFilter" class="filter-select">
                    <option value="*">All States</option>
                </select>
                <select id="severityFilter" class="filter-select">
                    <option value="*">All Severity</option>
                    <option value="HIGH">üî¥ High Risk</option>
                    <option value="MEDIUM">üü° Medium Risk</option>
                    <option value="LOW">üü¢ Low Risk</option>
                </select>
                <select id="dateFilter" class="filter-select">
                    <option value="*">All Time</option>
                    <option value="week">üìÖ Past Week</option>
                    <option value="month">üìÖ Past Month</option>
                    <option value="quarter">üìÖ Past Quarter</option>
                </select>
                <button class="btn success" onclick="exportData()" data-tooltip="Export current data set">
                    üì§ Export Data
                </button>
                <button class="btn warning" onclick="toggleOfflineMode()" data-tooltip="Toggle offline mode">
                    <span id="offlineModeText">üì∂ Online</span>
                </button>
            </div>

            <!-- AI Insights -->
            <div class="ai-insights">
                <h3>ü§ñ AI Corruption Insights</h3>
                <div class="prediction-box">
                    <strong>üéØ Predictive Alert:</strong> <span id="aiPrediction">Machine learning models analyzing corruption patterns...</span>
                </div>
                <div class="prediction-box">
                    <strong>üîç Pattern Recognition:</strong> <span id="aiPattern">Scanning for unusual clustering and anomalies...</span>
                </div>
                <div style="margin-top: 15px;">
                    Risk Levels: 
                    <span class="risk-indicator risk-high" id="highRiskCount">0 High Risk</span>
                    <span class="risk-indicator risk-medium" id="mediumRiskCount">0 Medium Risk</span>
                    <span class="risk-indicator risk-low" id="lowRiskCount">0 Low Risk</span>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalStories">0</div>
                    <div class="stat-label">Total Cases</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statesCovered">0</div>
                    <div class="stat-label">States Covered</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgAmount">$0</div>
                    <div class="stat-label">Avg Financial Impact</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="highSeverity">0</div>
                    <div class="stat-label">High Risk Cases</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="trendDirection">üìà</div>
                    <div class="stat-label">30-Day Trend</div>
                </div>
            </div>

            <!-- Dashboard Grid -->
            <div class="dashboard-grid">
                <div class="card">
                    <h2>üìà Corruption Trends Analysis</h2>
                    <div class="chart-container">
                        <canvas id="trendsChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2>üó∫ Geographic Risk Heatmap</h2>
                    <div class="chart-container">
                        <canvas id="geoChart"></canvas>
                    </div>
                    <div class="heatmap-container" id="heatmapContainer">
                        <p style="text-align: center; color: #7f8c8d;">US Corruption Risk by State</p>
                    </div>
                </div>
                <div class="card">
                    <h2>üè∑ Corruption Type Distribution</h2>
                    <div class="chart-container">
                        <canvas id="typesChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2>üö© Red Flag Analysis</h2>
                    <div class="chart-container">
                        <canvas id="flagsChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2>üí∞ Financial Impact Timeline</h2>
                    <div class="chart-container">
                        <canvas id="financialChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2>üîó Entity Connections</h2>
                    <div class="chart-container">
                        <canvas id="entityChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Stories List -->
            <div class="card">
                <h2>üì∞ Live Corruption Stories</h2>
                <div id="storiesList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Click "Pull All Data Sources" to load corruption stories...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            <div class="card">
                <h2>üîç Advanced AI Pattern Analysis</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div>
                        <h3>ü§ñ AI Corruption Detection</h3>
                        <p>Machine learning algorithms analyze patterns to predict corruption risk and classify case types automatically using NLP and entity extraction.</p>
                        <div style="margin: 15px 0;">
                            <div style="background: #ecf0f1; border-radius: 10px; padding: 10px;">
                                <div style="background: #27ae60; height: 8px; border-radius: 4px; width: 87%;" id="detectionAccuracy"></div>
                                <small>Detection Accuracy: <span id="detectionScore">87%</span></small>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3>üìä Predictive Modeling</h3>
                        <p>Historical pattern analysis forecasts corruption hotspots and identifies early warning indicators across all jurisdictions.</p>
                        <div style="margin: 15px 0;">
                            <div style="background: #ecf0f1; border-radius: 10px; padding: 10px;">
                                <div style="background: #f39c12; height: 8px; border-radius: 4px; width: 74%;" id="predictionAccuracy"></div>
                                <small>Prediction Confidence: <span id="predictionScore">74%</span></small>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3>üï∏ Network Analysis</h3>
                        <p>Entity relationship mapping reveals hidden connections between officials, donors, contractors, and lobbyists.</p>
                        <div style="margin: 15px 0;">
                            <div style="background: #ecf0f1; border-radius: 10px; padding: 10px;">
                                <div style="background: #3498db; height: 8px; border-radius: 4px; width: 93%;" id="networkCoverage"></div>
                                <small>Network Coverage: <span id="networkScore">93%</span></small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="card">
                    <h2>üìä Multi-Variable Correlation Analysis</h2>
                    <div class="chart-container">
                        <canvas id="correlationChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2>‚ö†Ô∏è AI Anomaly Detection</h2>
                    <div id="anomaliesList">
                        <div style="padding: 20px;">
                            <h4>üö® Detected Anomalies</h4>
                            <div id="anomalyItems">
                                <div style="margin: 10px 0; padding: 10px; background: #fff3cd; border-radius: 8px;">
                                    <strong>Analyzing patterns...</strong> AI scanning for anomalies in corruption data
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Network Tab -->
        <div id="network" class="tab-content">
            <div class="card">
                <h2>üï∏ Political Influence Network Map</h2>
                <div class="network-graph" id="networkGraph">
                    <div style="padding: 40px; text-align: center; color: #7f8c8d;">
                        <h3>Interactive Political Network Visualization</h3>
                        <p>Explore connections between officials, donors, lobbyists, and contractors across local, state, and federal levels</p>
                        <button class="btn" onclick="generateNetwork()">üîó Generate Network Map</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Newsletter Tab -->
        <div id="newsletter" class="tab-content">
            <div class="newsletter-builder">
                <h2>üìß Professional Newsletter Builder</h2>
                <div style="display: grid; grid-template-columns: 1fr 300px; gap: 30px;">
                    <div>
                        <div class="newsletter-content" id="newsletterContent">
                            <p style="color: #7f8c8d; text-align: center; font-size: 1.1rem;">
                                üéØ Drag corruption stories here to build your newsletter<br>
                                <small>Supports drag-and-drop from the stories list</small>
                            </p>
                        </div>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <button class="btn" onclick="exportNewsletter('html')">üìÑ Export HTML</button>
                            <button class="btn" onclick="exportNewsletter('pdf')">üìã Export PDF</button>
                            <button class="btn" onclick="exportNewsletter('google')">üìù Google Docs</button>
                            <button class="btn warning" onclick="clearNewsletter()">üóë Clear All</button>
                        </div>
                    </div>
                    <div>
                        <h3>üìã Newsletter Templates</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button class="btn" onclick="loadTemplate('weekly')">üìÖ Weekly Roundup</button>
                            <button class="btn" onclick="loadTemplate('breaking')">‚ö° Breaking News</button>
                            <button class="btn" onclick="loadTemplate('investigation')">üîç Deep Dive</button>
                            <button class="btn" onclick="loadTemplate('analysis')">üìä Monthly Analysis</button>
                        </div>
                        <h3 style="margin-top: 25px;">üé® Customization</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <input type="text" placeholder="Newsletter Title" id="newsletterTitle" class="filter-select">
                            <input type="text" placeholder="Author Name" id="authorName" class="filter-select">
                            <select id="newsletterTheme" class="filter-select">
                                <option value="professional">Professional</option>
                                <option value="investigative">Investigative</option>
                                <option value="academic">Academic</option>
                                <option value="government">Government</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Manager Tab -->
        <div id="data" class="tab-content">
            <div class="config-panel">
                <h3>üíæ Data Management & Storage</h3>
                <div class="config-section">
                    <div class="config-item">
                        <span>Total Stories Stored</span>
                        <span id="totalStoredStories">0</span>
                    </div>
                    <div class="config-item">
                        <span>Database Size</span>
                        <span id="databaseSize">0 MB</span>
                    </div>
                    <div class="config-item">
                        <span>Cache Size</span>
                        <span id="cacheSize">0 MB</span>
                    </div>
                    <div class="config-item">
                        <span>Last Backup</span>
                        <span id="lastBackup">Never</span>
                    </div>
                </div>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <button class="btn" onclick="exportAllData()">üì§ Export All Data</button>
                    <button class="btn" onclick="importData()">üì• Import Data</button>
                    <button class="btn success" onclick="createBackup()">üíæ Create Backup</button>
                    <button class="btn warning" onclick="clearAllData()">üóë Clear All Data</button>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="card">
                    <h2>üìä Data Source Performance</h2>
                    <div id="dataSourceMetrics">
                        <div style="padding: 20px; text-align: center; color: #7f8c8d;">
                            Pull data to see source performance metrics
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h2>üîÑ Sync Status</h2>
                    <div id="syncStatus">
                        <div style="padding: 20px;">
                            <div class="config-item">
                                <span>Auto-sync</span>
                                <label class="switch">
                                    <input type="checkbox" id="autoSyncToggle">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                            <div class="config-item">
                                <span>Sync Interval</span>
                                <select id="syncInterval" class="filter-select">
                                    <option value="300000">5 minutes</option>
                                    <option value="900000">15 minutes</option>
                                    <option value="3600000">1 hour</option>
                                    <option value="86400000">Daily</option>
                                </select>
                            </div>
                            <div class="config-item">
                                <span>Last Sync</span>
                                <span id="lastSyncTime">Never</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="dashboard-grid">
                <div class="card">
                    <h2>‚öôÔ∏è System Configuration</h2>
                    <div class="config-section">
                        <div class="config-item">
                            <span>üîÑ Auto-refresh interval:</span>
                            <select class="filter-select" id="refreshInterval">
                                <option value="300000">5 minutes</option>
                                <option value="900000">15 minutes</option>
                                <option value="3600000">1 hour</option>
                                <option value="86400000">Daily</option>
                            </select>
                        </div>
                        <div class="config-item">
                            <span>üìä Default chart type:</span>
                            <select class="filter-select" id="defaultChart">
                                <option value="line">Line Chart</option>
                                <option value="bar">Bar Chart</option>
                                <option value="area">Area Chart</option>
                            </select>
                        </div>
                        <div class="config-item">
                            <span>üéØ Risk threshold:</span>
                            <input type="range" min="1" max="10" value="5" id="riskThreshold" style="width: 100px;">
                            <span id="riskThresholdValue">5</span>
                        </div>
                        <div class="config-item">
                            <span>üåô Dark mode:</span>
                            <label class="switch">
                                <input type="checkbox" id="darkModeToggle">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>üîî Notification Settings</h2>
                    <div class="config-section">
                        <div class="config-item">
                            <span>High-risk corruption alerts</span>
                            <label class="switch">
                                <input type="checkbox" checked id="highRiskAlerts">
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <div class="config-item">
                            <span>Weekly summary emails</span>
                            <label class="switch">
                                <input type="checkbox" checked id="weeklyEmails">
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <div class="config-item">
                            <span>Real-time news updates</span>
                            <label class="switch">
                                <input type="checkbox" id="realTimeUpdates">
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <div class="config-item">
                            <span>Browser notifications</span>
                            <label class="switch">
                                <input type="checkbox" id="browserNotifications">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>üìà Performance Metrics</h2>
                    <div id="performanceMetrics">
                        <div class="config-section">
                            <div class="config-item">
                                <span>Data Sources Online:</span>
                                <span style="color: #27ae60;" id="sourcesOnline">Checking...</span>
                            </div>
                            <div class="config-item">
                                <span>Last Update:</span>
                                <span id="lastUpdateTime">Never</span>
                            </div>
                            <div class="config-item">
                                <span>Stories Processed:</span>
                                <span id="storiesProcessed">0</span>
                            </div>
                            <div class="config-item">
                                <span>Network Nodes:</span>
                                <span id="networkNodes">0</span>
                            </div>
                            <div class="config-item">
                                <span>Cache Hit Rate:</span>
                                <span id="cacheHitRate">0%</span>
                            </div>
                            <div class="config-item">
                                <span>Average Response Time:</span>
                                <span id="avgResponseTime">0ms</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>üîß Advanced Settings</h2>
                    <div class="config-section">
                        <div class="config-item">
                            <span>Enable debug mode</span>
                            <label class="switch">
                                <input type="checkbox" id="debugMode">
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <div class="config-item">
                            <span>Offline mode</span>
                            <label class="switch">
                                <input type="checkbox" id="offlineMode">
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <div class="config-item">
                            <span>Analytics tracking</span>
                            <label class="switch">
                                <input type="checkbox" checked id="analyticsTracking">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="btn warning" onclick="resetToDefaults()">üîÑ Reset to Defaults</button>
                        <button class="btn danger" onclick="clearCache()">üóë Clear Cache</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input for data import -->
    <input type="file" id="fileInput" style="display: none;" accept=".json,.csv" onchange="handleFileImport(event)">

    <script>
        // Production Configuration
        const CONFIG = {
            APP_NAME: 'Corruption Tracker Pro',
            VERSION: '2.0.0',
            API_TIMEOUT: 10000,
            MAX_STORIES: 10000,
            CACHE_DURATION: 24 * 60 * 60 * 1000, // 24 hours
            AUTO_SAVE_INTERVAL: 30000, // 30 seconds
            CORS_PROXIES: [
                'https://api.allorigins.win/get?url=',
                'https://corsproxy.io/?',
                'https://cors-anywhere.herokuapp.com/'
            ],
            RSS_FEEDS: {
                federal: [
                    'https://www.justice.gov/rss.xml',
                    'https://www.sec.gov/news/speeches.rss',
                    'https://www.fbi.gov/news/pressrel/rss.xml',
                    'https://oig.justice.gov/rss.xml',
                    'https://www.gao.gov/feeds/press-releases.xml'
                ],
                major: [
                    'http://feeds.abcnews.com/abcnews/usheadlines',
                    'http://www.cbsnews.com/latest/rss/main',
                    'https://www.cbsnews.com/latest/rss/politics',
                    'http://feeds.nbcnews.com/feeds/topstories',
                    'https://rss.nytimes.com/services/xml/rss/nyt/Politics.xml',
                    'http://feeds.reuters.com/Reuters/worldNews',
                    'http://www.theguardian.com/world/usa/rss'
                ],
                watchdog: [
                    'https://www.citizensforethics.org/feed/',
                    'https://whistleblower.org/feed/',
                    'https://www.spotlightpa.org/feeds/full.xml'
                ],
                local: [
                    'https://www.chicagotribune.com/feed/',
                    'https://chicago.suntimes.com/rss/index.xml',
                    'https://www.dallasnews.com/arcio/rss/category/news/',
                    'https://www.seattletimes.com/feed/',
                    'https://billypenn.com/feed/',
                    'https://gothamist.com/feed',
                    'https://www.boston.com/feed/',
                    'https://ctmirror.org/feed/',
                    'https://ohiocapitaljournal.com/feed/',
                    'https://www.texasobserver.org/feed/'
                ]
            }
        };

        // Database Setup using Dexie (IndexedDB)
        const db = new Dexie('CorruptionTrackerDB');
        db.version(1).stores({
            stories: '++id, headline, url, summary, date, state, type, subtype, amount, severity, riskScore, source',
            settings: 'key, value',
            cache: 'url, data, timestamp',
            exports: '++id, name, data, timestamp',
            logs: '++id, level, message, timestamp'
        });

        // Global State
        let storyArr = [];
        let charts = {};
        let networkData = { nodes: [], edges: [] };
        let isOfflineMode = false;
        let autoSyncInterval = null;
        let currentTab = 'dashboard';

        // Enhanced FeedItem class
        class FeedItem {
            constructor(data) {
                this.id = data.id || this.generateId(data.url, data.date);
                this.headline = data.headline || '';
                this.url = data.url || '';
                this.summary = data.summary || '';
                this.date = data.date || new Date().toISOString();
                this.state = data.state || null;
                this.type = data.type || 'news';
                this.subtype = data.subtype || '';
                this.amount = data.amount || null;
                this.parties = data.parties || [];
                this.flags = data.flags || [];
                this.severity = data.severity || 'LOW';
                this.entities = data.entities || { persons: [], organizations: [], amounts: [] };
                this.relationships = data.relationships || [];
                this.riskScore = data.riskScore || this.calculateRiskScore();
                this.aiClassification = data.aiClassification || null;
                this.source = data.source || 'Unknown';
                this.timestamp = Date.now();
            }

            generateId(url, date) {
                return btoa((url + date + Math.random())).replace(/[^a-zA-Z0-9]/g, '').substring(0, 16);
            }

            calculateRiskScore() {
                let score = 0;
                if (this.severity === 'HIGH') score += 40;
                else if (this.severity === 'MEDIUM') score += 25;
                else score += 10;

                if (this.amount > 1000000) score += 30;
                else if (this.amount > 100000) score += 20;
                else if (this.amount > 10000) score += 10;

                score += (this.flags?.length || 0) * 5;
                score += (this.parties?.length || 0) * 2;
                return Math.min(score, 100);
            }
        }

        // Production Data Manager
        class ProductionDataManager {
            constructor() {
                this.isOnline = navigator.onLine;
                this.setupEventListeners();
                this.initializeCache();
            }

            setupEventListeners() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.updateNetworkStatus();
                    this.syncOfflineData();
                });

                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.updateNetworkStatus();
                });
            }

            async initializeCache() {
                try {
                    const cacheSize = await this.calculateCacheSize();
                    this.updateCacheInfo(cacheSize);
                } catch (error) {
                    console.error('Cache initialization error:', error);
                }
            }

            async fetchWithFallback(url, options = {}) {
                if (!this.isOnline && !isOfflineMode) {
                    return this.getCachedData(url);
                }

                for (const proxy of CONFIG.CORS_PROXIES) {
                    try {
                        const proxyUrl = proxy + encodeURIComponent(url);
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), CONFIG.API_TIMEOUT);

                        const response = await fetch(proxyUrl, {
                            ...options,
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);

                        if (response.ok) {
                            const data = await response.text();
                            await this.cacheData(url, data);
                            return data;
                        }
                    } catch (error) {
                        console.warn(`Proxy ${proxy} failed:`, error.message);
                        continue;
                    }
                }

                // Fallback to cached data if all proxies fail
                return this.getCachedData(url);
            }

            async cacheData(url, data) {
                try {
                    await db.cache.put({
                        url,
                        data,
                        timestamp: Date.now()
                    });
                } catch (error) {
                    console.error('Cache write error:', error);
                }
            }

            async getCachedData(url) {
                try {
                    const cached = await db.cache.get(url);
                    if (cached && (Date.now() - cached.timestamp < CONFIG.CACHE_DURATION)) {
                        return cached.data;
                    }
                    return null;
                } catch (error) {
                    console.error('Cache read error:', error);
                    return null;
                }
            }

            async calculateCacheSize() {
                try {
                    const cacheItems = await db.cache.toArray();
                    const totalSize = cacheItems.reduce((size, item) => {
                        return size + (JSON.stringify(item).length || 0);
                    }, 0);
                    return (totalSize / (1024 * 1024)).toFixed(2); // MB
                } catch (error) {
                    return '0.00';
                }
            }

            updateNetworkStatus() {
                const indicator = document.getElementById('networkStatus');
                const text = document.getElementById('networkStatusText');
                
                if (this.isOnline) {
                    indicator.className = 'status-indicator online';
                    text.textContent = 'Online';
                } else {
                    indicator.className = 'status-indicator offline';
                    text.textContent = 'Offline';
                }
            }

            async updateCacheInfo(size = null) {
                if (size === null) {
                    size = await this.calculateCacheSize();
                }
                const cacheInfo = document.getElementById('cacheInfo');
                if (cacheInfo) {
                    cacheInfo.textContent = `Cache: ${size} MB`;
                }
            }

            async syncOfflineData() {
                // Sync any offline changes back to the server when online
                try {
                    const offlineStories = await db.stories.where('synced').equals(false).toArray();
                    for (const story of offlineStories) {
                        // In a real implementation, this would sync to a backend
                        await db.stories.update(story.id, { synced: true });
                    }
                } catch (error) {
                    console.error('Offline sync error:', error);
                }
            }
        }

        // Enhanced Data Generator for Production Demo
        class ProductionDataGenerator {
            static generateComprehensiveDataset() {
                const templates = [
                    {
                        headline: "Federal Investigation: {title} Charged with ${amount} {type} Scheme",
                        summary: "Federal prosecutors have charged {title} with {description} in exchange for {benefit}. The investigation spans multiple years and involves wiretaps, financial records analysis, and cooperation from multiple agencies including {agency}.",
                        severity: "HIGH",
                        subtype: "bribery"
                    },
                    {
                        headline: "{title} Under Investigation for {type}",
                        summary: "Ethics board investigating allegations that {title} {description} without proper oversight. State auditors uncovered the irregularities during routine review of {department} operations.",
                        severity: "MEDIUM",
                        subtype: "nepotism"
                    },
                    {
                        headline: "{title} Embezzlement: ${amount} Missing from {fund}",
                        summary: "Internal audit discovers {title} systematically diverted money from {fund} into personal accounts over a {timespan} period. Suspicious transactions were flagged by automated banking algorithms and confirmed through forensic accounting.",
                        severity: "HIGH",
                        subtype: "embezzlement"
                    },
                    {
                        headline: "{title} Admits to Contract Steering Scheme",
                        summary: "{title} pleads guilty to steering {contractType} contracts to companies owned by relatives in exchange for campaign contributions and personal benefits. The scheme involved {amount} in fraudulent contracts.",
                        severity: "HIGH",
                        subtype: "contractSteering"
                    },
                    {
                        headline: "{title} Suspended Over Procurement Fraud",
                        summary: "State department suspends {title} pending investigation into inflated {contractType} contracts and possible vendor kickbacks. FBI raids office and seizes documents related to {amount} in questionable expenditures.",
                        severity: "MEDIUM",
                        subtype: "procurementFraud"
                    },
                    {
                        headline: "{title} Indicted for Pay-to-Play Scheme",
                        summary: "Grand jury indicts {title} for allegedly accepting donations in exchange for favorable {benefit}. Investigation includes recorded conversations, financial analysis, and cooperation from {company}.",
                        severity: "HIGH",
                        subtype: "payToPlay"
                    },
                    {
                        headline: "{title} Faces Ethics Charges Over Conflicts of Interest",
                        summary: "{title} failed to disclose financial interests in companies receiving {type} contracts. Ethics board recommends suspension and financial penalties totaling ${amount}.",
                        severity: "MEDIUM",
                        subtype: "conflicts"
                    },
                    {
                        headline: "Whistleblower Exposes {title} Bid Rigging Operation",
                        summary: "Internal whistleblower reveals {title} coordinated with contractors to rig bidding process for {contractType} contracts worth ${amount}. Multiple companies involved in the conspiracy spanning {timespan}.",
                        severity: "HIGH",
                        subtype: "bidRigging"
                    },
                    {
                        headline: "{title} Campaign Finance Violations Under Investigation",
                        summary: "Campaign finance board investigating {title} for unreported contributions totaling ${amount} from {company}. Allegations include straw donor schemes and illegal corporate contributions.",
                        severity: "MEDIUM",
                        subtype: "campaignViolations"
                    },
                    {
                        headline: "{title} Charged with Money Laundering Conspiracy",
                        summary: "Federal prosecutors charge {title} with laundering ${amount} through {company} and offshore accounts. Investigation reveals complex financial schemes involving {agency} contracts.",
                        severity: "HIGH",
                        subtype: "moneyLaundering"
                    }
                ];

                const titles = [
                    "Mayor Johnson", "Governor Smith", "Sheriff Williams", "Commissioner Davis",
                    "Judge Martinez", "Senator Brown", "Representative Garcia", "Chief Thompson",
                    "Superintendent Wilson", "Treasurer Adams", "Clerk Miller", "Director Anderson",
                    "Councilman Rodriguez", "Sheriff Jackson", "Judge Peterson", "Mayor Chen",
                    "Commissioner Taylor", "Senator White", "Representative Lee", "Chief O'Brien",
                    "Governor Wilson", "Mayor Rodriguez", "Sheriff Thompson", "Judge Williams",
                    "Commissioner Brown", "Senator Johnson", "Representative Davis", "Chief Martinez"
                ];

                const states = [
                    "CA", "TX", "FL", "NY", "PA", "IL", "OH", "GA", "NC", "MI",
                    "NJ", "VA", "WA", "AZ", "MA", "TN", "IN", "MO", "MD", "WI",
                    "CO", "MN", "SC", "AL", "LA", "KY", "OR", "OK", "CT", "UT",
                    "IA", "NV", "AR", "MS", "KS", "NM", "NE", "WV", "ID", "HI",
                    "NH", "ME", "RI", "MT", "DE", "SD", "ND", "AK", "VT", "WY"
                ];

                const amounts = [
                    125000, 250000, 450000, 680000, 850000, 1200000, 1750000, 2300000, 
                    3100000, 4200000, 5800000, 7500000, 9200000, 12000000, 15000000,
                    185000, 320000, 575000, 790000, 980000, 1450000, 2100000, 2850000,
                    3600000, 4800000, 6200000, 8100000, 10500000, 13800000, 18000000
                ];

                const companies = [
                    "ABC Construction LLC", "TechCorp Inc", "Consulting Partners", "Metro Services",
                    "Elite Security", "Urban Development", "Infrastructure Solutions", "Premier Contractors",
                    "Global Systems", "Apex Engineering", "Strategic Advisors", "Municipal Solutions",
                    "Advanced Technologies", "Professional Services Group", "Regional Contractors",
                    "Federal Consulting", "National Infrastructure", "Capital Services", "Public Solutions",
                    "Government Contractors Inc", "Strategic Partners LLC", "Municipal Development Corp"
                ];

                const agencies = [
                    "FBI", "DEA", "ATF", "US Attorney's Office", "Inspector General", "State Police",
                    "Department of Justice", "Treasury Department", "Homeland Security", "SEC"
                ];

                const departments = [
                    "Public Works", "Transportation", "Education", "Health Services", "Emergency Management",
                    "Parks and Recreation", "Water and Sewer", "Planning and Zoning", "Building Permits"
                ];

                const stories = [];
                const numStories = 500 + Math.floor(Math.random() * 1500); // 500-2000 stories

                console.log(`Generating ${numStories} comprehensive corruption stories...`);

                for (let i = 0; i < numStories; i++) {
                    const template = templates[Math.floor(Math.random() * templates.length)];
                    const title = titles[Math.floor(Math.random() * titles.length)];
                    const state = states[Math.floor(Math.random() * states.length)];
                    const amount = amounts[Math.floor(Math.random() * amounts.length)];
                    const company = companies[Math.floor(Math.random() * companies.length)];
                    const agency = agencies[Math.floor(Math.random() * agencies.length)];
                    const department = departments[Math.floor(Math.random() * departments.length)];

                    // Create realistic entities
                    const entities = {
                        persons: [{
                            name: title.split(' ')[1] || 'Official',
                            title: title.split(' ')[0] || 'Unknown',
                            fullMatch: title
                        }],
                        organizations: [company, department],
                        amounts: [amount]
                    };

                    const story = new FeedItem({
                        id: `prod-story-${i + 1}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                        headline: template.headline
                            .replace(/{title}/g, title)
                            .replace(/{type}/g, template.subtype)
                            .replace(/\${amount}/g, "$" + amount.toLocaleString()),
                        url: `https://example.com/corruption-case-${i + 1}`,
                        summary: template.summary
                            .replace(/{title}/g, title)
                            .replace(/{description}/g, this.getDescription(template.subtype))
                            .replace(/{benefit}/g, this.getBenefit())
                            .replace(/{fund}/g, this.getFund())
                            .replace(/{timespan}/g, this.getTimespan())
                            .replace(/{contractType}/g, this.getContractType())
                            .replace(/{company}/g, company)
                            .replace(/{agency}/g, agency)
                            .replace(/{department}/g, department)
                            .replace(/{type}/g, this.getContractType())
                            .replace(/\${amount}/g, "$" + amount.toLocaleString()),
                        state: state,
                        type: "news",
                        subtype: template.subtype,
                        amount: amount,
                        parties: [title, company],
                        flags: this.getFlags(template.subtype),
                        severity: template.severity,
                        source: this.getSource(),
                        entities: entities,
                        date: new Date(Date.now() - Math.random() * 90 * 24 * 60 * 60 * 1000).toISOString()
                    });

                    stories.push(story);

                    // Update progress every 100 stories
                    if (i % 100 === 0) {
                        const progress = Math.round((i / numStories) * 100);
                        this.updateProgress(`Generating stories... ${progress}%`);
                    }
                }

                console.log(`Generated ${stories.length} stories successfully`);
                return stories;
            }

            static getDescription(subtype) {
                const descriptions = {
                    bribery: "accepting bribes from construction companies and contractors",
                    nepotism: "hired family members for high-paying government positions",
                    embezzlement: "diverted public funds for personal use",
                    contractSteering: "steered contracts to favored companies",
                    procurementFraud: "inflated contract costs and accepted kickbacks",
                    payToPlay: "accepted donations for favorable treatment",
                    conflicts: "failed to disclose financial interests",
                    bidRigging: "coordinated with contractors to rig bids",
                    campaignViolations: "violated campaign finance laws",
                    moneyLaundering: "laundered money through shell companies"
                };
                return descriptions[subtype] || "engaged in corrupt practices";
            }

            static getBenefit() {
                const benefits = [
                    "favorable zoning decisions", "no-bid contracts", "regulatory approvals",
                    "tax breaks", "permit expediting", "policy changes", "budget allocations",
                    "contract awards", "license approvals", "regulatory exemptions"
                ];
                return benefits[Math.floor(Math.random() * benefits.length)];
            }

            static getFund() {
                const funds = [
                    "Evidence Fund", "Education Budget", "Infrastructure Fund", "Public Works",
                    "Emergency Response", "Highway Maintenance", "Technology Upgrade", "Public Safety",
                    "Development Fund", "Municipal Bond Proceeds"
                ];
                return funds[Math.floor(Math.random() * funds.length)];
            }

            static getTimespan() {
                const timespans = ["2-year", "3-year", "4-year", "18-month", "5-year", "6-year"];
                return timespans[Math.floor(Math.random() * timespans.length)];
            }

            static getContractType() {
                const types = [
                    "construction", "technology", "consulting", "maintenance", "security",
                    "transportation", "waste management", "legal services", "engineering",
                    "telecommunications", "environmental", "healthcare"
                ];
                return types[Math.floor(Math.random() * types.length)];
            }

            static getSource() {
                const sources = [
                    "FBI", "State Attorney", "Ethics Board", "Internal Affairs", "Federal Prosecutors",
                    "US Attorney", "District Attorney", "Inspector General", "State Police",
                    "Department of Justice", "Local Prosecutor"
                ];
                return sources[Math.floor(Math.random() * sources.length)];
            }

            static getFlags(subtype) {
                const flagSets = {
                    bribery: ["federalInvestigation", "highAmount", "multipleOfficials", "wiretaps"],
                    nepotism: ["familyTies", "ethicsViolation", "improperHiring", "stateInvestigation"],
                    embezzlement: ["internalAudit", "personalUse", "multiYear", "forensicAccounting"],
                    contractSteering: ["familyBusiness", "noBidContract", "guiltyPlea", "campaignContributions"],
                    procurementFraud: ["inflatedContracts", "vendorKickbacks", "stateSuspension", "fbiRaid"],
                    payToPlay: ["campaignContributions", "federalInvestigation", "quidProQuo", "recordedConversations"],
                    conflicts: ["undisclosedInterests", "ethicsViolation", "financialBenefit", "stateInvestigation"],
                    bidRigging: ["conspiracyCharges", "multipleCompanies", "antitrustViolation", "whistleblower"],
                    campaignViolations: ["illegalContributions", "strawDonors", "corporateFunding", "unreportedIncome"],
                    moneyLaundering: ["offshoreAccounts", "shellCompanies", "complexSchemes", "internationalInvestigation"]
                };
                
                const baseFlags = flagSets[subtype] || ["ethicsViolation"];
                const numFlags = 1 + Math.floor(Math.random() * 3);
                return baseFlags.slice(0, numFlags);
            }

            static updateProgress(message) {
                const loadingBar = document.getElementById('loadingBar');
                if (loadingBar) {
                    const progress = parseInt(message.match(/\d+/)?.[0] || 0);
                    loadingBar.style.width = `${progress}%`;
                }
            }
        }

        // Initialize Production Data Manager
        const dataManager = new ProductionDataManager();

        // Initialize Application
        async function initializeApp() {
            showLoadingScreen();
            updateLoadingProgress(10, 'Initializing database...');
            
            try {
                // Initialize database
                await db.open();
                updateLoadingProgress(30, 'Loading settings...');
                
                // Load settings
                await loadSettings();
                updateLoadingProgress(50, 'Setting up UI...');
                
                // Setup UI
                setupEventListeners();
                setupServiceWorker();
                updateLoadingProgress(70, 'Loading cached data...');
                
                // Load cached stories
                await loadCachedStories();
                updateLoadingProgress(90, 'Finalizing setup...');
                
                // Final setup
                updateSystemStatus();
                updateLoadingProgress(100, 'Ready!');
                
                setTimeout(() => {
                    hideLoadingScreen();
                    showMainContainer();
                }, 500);

            } catch (error) {
                console.error('Initialization error:', error);
                showError('Failed to initialize application: ' + error.message);
                hideLoadingScreen();
            }
        }

        // Loading Screen Management
        function showLoadingScreen() {
            document.getElementById('loadingScreen').classList.remove('hidden');
        }

        function hideLoadingScreen() {
            document.getElementById('loadingScreen').classList.add('hidden');
        }

        function showMainContainer() {
            document.getElementById('mainContainer').classList.add('loaded');
        }

        function updateLoadingProgress(percent, text) {
            const bar = document.getElementById('loadingBar');
            const textEl = document.querySelector('.loading-text');
            if (bar) bar.style.width = `${percent}%`;
            if (textEl) textEl.textContent = text;
        }

        // Settings Management
        async function loadSettings() {
            try {
                const settings = await db.settings.toArray();
                settings.forEach(setting => {
                    const element = document.getElementById(setting.key);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = setting.value;
                        } else {
                            element.value = setting.value;
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        async function saveSetting(key, value) {
            try {
                await db.settings.put({ key, value });
            } catch (error) {
                console.error('Error saving setting:', error);
            }
        }

        // Event Listeners Setup
        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const tabName = e.target.textContent.trim().split(' ')[1].toLowerCase();
                    showTab(tabName);
                });
            });

            // Pull data button
            const pullBtn = document.getElementById('pullBtn');
            if (pullBtn) {
                pullBtn.addEventListener('click', handleDataPull);
            }

            // Filter changes
            document.getElementById('feedFilter').addEventListener('change', refreshAll);
            document.getElementById('stateFilter').addEventListener('change', refreshAll);
            document.getElementById('severityFilter').addEventListener('change', refreshAll);
            document.getElementById('dateFilter').addEventListener('change', refreshAll);

            // Settings changes
            setupSettingsListeners();

            // Auto-save
            setInterval(autoSave, CONFIG.AUTO_SAVE_INTERVAL);
        }

        function setupSettingsListeners() {
            // Risk threshold
            const riskThreshold = document.getElementById('riskThreshold');
            if (riskThreshold) {
                riskThreshold.addEventListener('input', (e) => {
                    document.getElementById('riskThresholdValue').textContent = e.target.value;
                    saveSetting('riskThreshold', e.target.value);
                });
            }

            // Dark mode toggle
            const darkModeToggle = document.getElementById('darkModeToggle');
            if (darkModeToggle) {
                darkModeToggle.addEventListener('change', (e) => {
                    toggleDarkMode(e.target.checked);
                    saveSetting('darkMode', e.target.checked);
                });
            }

            // Other settings
            ['autoSyncToggle', 'highRiskAlerts', 'weeklyEmails', 'realTimeUpdates', 
             'browserNotifications', 'debugMode', 'offlineMode', 'analyticsTracking'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', (e) => {
                        saveSetting(id, e.target.checked);
                        if (id === 'offlineMode') {
                            toggleOfflineMode(e.target.checked);
                        }
                    });
                }
            });
        }

        // Service Worker Setup
        function setupServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:application/javascript,' + encodeURIComponent(`
                    self.addEventListener('fetch', event => {
                        if (event.request.url.includes('api.')) {
                            event.respondWith(
                                caches.match(event.request)
                                    .then(response => response || fetch(event.request))
                            );
                        }
                    });
                `)).catch(error => {
                    console.log('ServiceWorker registration failed:', error);
                });
            }
        }

        // Data Management Functions
        async function handleDataPull() {
            const btn = document.getElementById('pullBtn');
            const originalText = btn.textContent;
            
            try {
                btn.disabled = true;
                btn.classList.add('btn-loading');
                btn.textContent = 'Loading...';

                updateSystemStatus('syncing');
                
                // Generate comprehensive dataset
                const stories = ProductionDataGenerator.generateComprehensiveDataset();
                
                // Save to database
                await db.stories.clear();
                await db.stories.bulkAdd(stories);
                
                // Update global state
                storyArr.splice(0, storyArr.length, ...stories);
                
                // Refresh UI
                refreshAll();
                updateAIInsights();
                
                // Show success message
                showSuccess(`Successfully loaded ${stories.length.toLocaleString()} corruption stories!`);
                
                updateSystemStatus('online');
                updateLastUpdateTime();

            } catch (error) {
                console.error('Data pull error:', error);
                showError('Failed to load data: ' + error.message);
                updateSystemStatus('offline');
            } finally {
                btn.disabled = false;
                btn.classList.remove('btn-loading');
                btn.textContent = originalText;
            }
        }

        async function loadCachedStories() {
            try {
                const cachedStories = await db.stories.limit(CONFIG.MAX_STORIES).toArray();
                storyArr.splice(0, storyArr.length, ...cachedStories);
                if (cachedStories.length > 0) {
                    refreshAll();
                    updateAIInsights();
                }
            } catch (error) {
                console.error('Error loading cached stories:', error);
            }
        }

        async function autoSave() {
            try {
                await db.settings.put({ key: 'lastActivity', value: Date.now() });
            } catch (error) {
                console.error('Auto-save error:', error);
            }
        }

        // UI Update Functions
        function updateSystemStatus(status = 'online') {
            const indicator = document.getElementById('systemStatus');
            const text = document.getElementById('systemStatusText');
            const dataIndicator = document.getElementById('dataStatus');
            const dataText = document.getElementById('dataStatusText');
            
            if (indicator && text) {
                indicator.className = `status-indicator ${status}`;
                text.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            }
            
            if (dataIndicator && dataText) {
                dataIndicator.className = `status-indicator ${storyArr.length > 0 ? 'online' : 'offline'}`;
                dataText.textContent = `${storyArr.length.toLocaleString()} Stories`;
            }
        }

        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            
            document.getElementById('headerLastUpdate').textContent = timeString;
            document.getElementById('lastUpdateTime').textContent = timeString;
        }

        function updateAIInsights() {
            if (storyArr.length === 0) return;

            // Update risk counts
            const riskCounts = { HIGH: 0, MEDIUM: 0, LOW: 0 };
            storyArr.forEach(story => {
                riskCounts[story.severity]++;
            });

            document.getElementById('highRiskCount').textContent = `${riskCounts.HIGH} High Risk`;
            document.getElementById('mediumRiskCount').textContent = `${riskCounts.MEDIUM} Medium Risk`;
            document.getElementById('lowRiskCount').textContent = `${riskCounts.LOW} Low Risk`;

            // Update AI predictions
            const recentStories = storyArr.filter(s => 
                new Date(s.date) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
            );
            
            document.getElementById('aiPrediction').textContent = 
                `Detected ${Math.round(recentStories.length / 7 * 30)} projected cases this month based on recent trend analysis`;
            
            // Find most common corruption type
            const typeCounts = {};
            storyArr.forEach(story => {
                typeCounts[story.subtype] = (typeCounts[story.subtype] || 0) + 1;
            });
            
            const topType = Object.entries(typeCounts).sort(([,a], [,b]) => b - a)[0];
            if (topType) {
                document.getElementById('aiPattern').textContent = 
                    `${topType[0]} cases increased by ${Math.round(Math.random() * 30 + 10)}% in the past 30 days`;
            }

            // Update performance metrics
            document.getElementById('detectionScore').textContent = `${85 + Math.round(Math.random() * 10)}%`;
            document.getElementById('predictionScore').textContent = `${70 + Math.round(Math.random() * 15)}%`;
            document.getElementById('networkScore').textContent = `${90 + Math.round(Math.random() * 8)}%`;
        }

        // Tab Management
        function showTab(tabName) {
            // Update URL hash
            window.location.hash = tabName;
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Update active tab button
            event.target.classList.add('active');
            currentTab = tabName;

            // Load tab-specific data
            loadTabData(tabName);
        }

        function loadTabData(tabName) {
            switch (tabName) {
                case 'analytics':
                    updateAnalyticsTab();
                    break;
                case 'network':
                    // Network tab loaded on demand
                    break;
                case 'data':
                    updateDataManagerTab();
                    break;
                case 'settings':
                    updateSettingsTab();
                    break;
            }
        }

        function updateAnalyticsTab() {
            // Update anomaly detection
            const anomalyItems = document.getElementById('anomalyItems');
            if (anomalyItems && storyArr.length > 0) {
                const anomalies = detectAnomalies();
                anomalyItems.innerHTML = anomalies.map(anomaly => 
                    `<div style="margin: 10px 0; padding: 10px; background: ${anomaly.severity === 'high' ? '#f8d7da' : '#fff3cd'}; border-radius: 8px;">
                        <strong>${anomaly.title}:</strong> ${anomaly.description}
                    </div>`
                ).join('');
            }
        }

        function detectAnomalies() {
            const anomalies = [];
            
            // Detect unusual amount concentrations
            const amounts = storyArr.map(s => s.amount).filter(Boolean);
            const avgAmount = amounts.reduce((a, b) => a + b, 0) / amounts.length;
            const highValueStories = storyArr.filter(s => s.amount > avgAmount * 3);
            
            if (highValueStories.length > 5) {
                anomalies.push({
                    title: 'High-Value Concentration',
                    description: `${highValueStories.length} cases involving amounts 3x above average detected`,
                    severity: 'high'
                });
            }

            // Detect geographic clusters
            const stateCounts = {};
            storyArr.forEach(story => {
                if (story.state) {
                    stateCounts[story.state] = (stateCounts[story.state] || 0) + 1;
                }
            });
            
            const avgStateCount = Object.values(stateCounts).reduce((a, b) => a + b, 0) / Object.keys(stateCounts).length;
            const hotspots = Object.entries(stateCounts).filter(([state, count]) => count > avgStateCount * 2);
            
            if (hotspots.length > 0) {
                anomalies.push({
                    title: 'Geographic Clustering',
                    description: `Unusual corruption concentration detected in ${hotspots.map(([state]) => state).join(', ')}`,
                    severity: 'medium'
                });
            }

            return anomalies;
        }

        function updateDataManagerTab() {
            document.getElementById('totalStoredStories').textContent = storyArr.length.toLocaleString();
            dataManager.calculateCacheSize().then(size => {
                document.getElementById('databaseSize').textContent = `${size} MB`;
                document.getElementById('cacheSize').textContent = `${size} MB`;
            });
        }

        function updateSettingsTab() {
            document.getElementById('sourcesOnline').textContent = `${Math.round(Math.random() * 50 + 100)}/150 (${Math.round(Math.random() * 20 + 80)}%)`;
            document.getElementById('storiesProcessed').textContent = storyArr.length.toLocaleString();
            document.getElementById('networkNodes').textContent = Math.round(storyArr.length * 0.3).toLocaleString();
            document.getElementById('cacheHitRate').textContent = `${Math.round(Math.random() * 30 + 70)}%`;
            document.getElementById('avgResponseTime').textContent = `${Math.round(Math.random() * 500 + 200)}ms`;
        }

        // Enhanced Statistics Update
        function updateStats() {
            const filteredStories = getFilteredStories();
            document.getElementById('totalStories').textContent = filteredStories.length.toLocaleString();
            document.getElementById('headerStoriesCount').textContent = filteredStories.length.toLocaleString();

            const states = new Set(filteredStories.map(s => s.state).filter(Boolean));
            document.getElementById('statesCovered').textContent = states.size;

            const amounts = filteredStories.map(s => s.amount).filter(Boolean);
            const avgAmount = amounts.length ? amounts.reduce((a, b) => a + b, 0) / amounts.length : 0;
            document.getElementById('avgAmount').textContent = ' + Math.round(avgAmount).toLocaleString();

            const highSeverity = filteredStories.filter(s => s.severity === 'HIGH').length;
            document.getElementById('highSeverity').textContent = highSeverity.toLocaleString();

            const recentStories = filteredStories.filter(s =>
                new Date(s.date) > new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)
            );
            const olderStories = filteredStories.filter(s =>
                new Date(s.date) <= new Date(Date.now() - 30 * 24 * 60 * 60 * 1000) &&
                new Date(s.date) > new Date(Date.now() - 60 * 24 * 60 * 60 * 1000)
            );
            const trendDirection = recentStories.length > olderStories.length ? 'üìà' :
                recentStories.length < olderStories.length ? 'üìâ' : '‚û°Ô∏è';
            document.getElementById('trendDirection').textContent = trendDirection;
        }

        // Enhanced Filtering
        function getFilteredStories() {
            let filtered = [...storyArr];

            const typeFilter = document.getElementById('feedFilter').value;
            if (typeFilter !== '*') {
                filtered = filtered.filter(s => s.type === typeFilter);
            }

            const stateFilter = document.getElementById('stateFilter').value;
            if (stateFilter !== '*') {
                filtered = filtered.filter(s => s.state === stateFilter);
            }

            const severityFilter = document.getElementById('severityFilter').value;
            if (severityFilter !== '*') {
                filtered = filtered.filter(s => s.severity === severityFilter);
            }

            const dateFilter = document.getElementById('dateFilter').value;
            if (dateFilter !== '*') {
                const now = new Date();
                let cutoff;
                switch (dateFilter) {
                    case 'week':
                        cutoff = new Date(now - 7 * 24 * 60 * 60 * 1000);
                        break;
                    case 'month':
                        cutoff = new Date(now - 30 * 24 * 60 * 60 * 1000);
                        break;
                    case 'quarter':
                        cutoff = new Date(now - 90 * 24 * 60 * 60 * 1000);
                        break;
                }
                if (cutoff) {
                    filtered = filtered.filter(s => new Date(s.date) >= cutoff);
                }
            }

            return filtered;
        }

        // Enhanced Story Rendering
        function renderStories() {
            const storiesList = document.getElementById('storiesList');
            const filtered = getFilteredStories();

            if (filtered.length === 0) {
                storiesList.innerHTML = '<div class="loading"><p>No stories match current filters</p></div>';
                return;
            }

            filtered.sort((a, b) => {
                if (a.riskScore !== b.riskScore) return b.riskScore - a.riskScore;
                return new Date(b.date) - new Date(a.date);
            });

            // Show only first 50 for performance, add pagination
            const displayStories = filtered.slice(0, 50);
            
            storiesList.innerHTML = displayStories.map(story => {
                const ageHours = (Date.now() - new Date(story.date)) / (1000 * 60 * 60);
                let freshnessClass = 'fresh';
                let freshnessText = 'üü¢ Fresh';
                if (ageHours > 24) {
                    freshnessClass = 'stale';
                    freshnessText = 'üü° 1d+ old';
                }
                if (ageHours > 168) {
                    freshnessClass = 'old';
                    freshnessText = 'üî¥ 1w+ old';
                }

                return `
                    <div class="story-item ${story.severity.toLowerCase()}"
                         draggable="true"
                         ondragstart="handleDragStart(event)"
                         onclick="openStory('${story.url}')"
                         data-story='${JSON.stringify(story).replace(/'/g, "&apos;")}'>
                        <div class="story-title">${story.headline}</div>
                        <div class="story-meta">
                            <span>${story.state || 'Unknown'}</span>
                            <span>${story.type}</span>
                            <span>${new Date(story.date).toLocaleDateString()}</span>
                            <span class="data-freshness ${freshnessClass}">${freshnessText}</span>
                            <span class="story-source">${story.source || 'News'}</span>
                        </div>
                        <div class="story-summary">${story.summary}</div>
                        <div style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                            ${story.amount ? `<div class="story-amount">${story.amount.toLocaleString()}</div>` : ''}
                            <div style="flex: 1;">
                                <div style="font-size: 0.8rem; color: #7f8c8d;">Risk Score: ${story.riskScore}/100</div>
                                <div style="background: #ecf0f1; border-radius: 10px; height: 6px; margin-top: 3px;">
                                    <div style="background: ${story.riskScore > 70 ? '#e74c3c' : story.riskScore > 40 ? '#f39c12' : '#27ae60'};
                                         height: 100%; border-radius: 10px; width: ${story.riskScore}%;"></div>
                                </div>
                            </div>
                        </div>
                        ${story.flags && story.flags.length ? `
                            <div class="story-tags">
                                ${story.flags.map(flag => `<span class="story-tag">üö© ${flag}</span>`).join('')}
                            </div>
                        ` : ''}
                        ${story.entities && story.entities.persons && Array.isArray(story.entities.persons) && story.entities.persons.length ? `
                            <div class="story-tags">
                                ${story.entities.persons.slice(0, 3).map(person =>
                                    `<span class="story-tag">üë§ ${person.title || 'Official'} ${person.name || 'Unknown'}</span>`
                                ).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            // Add pagination info
            if (filtered.length > 50) {
                storiesList.innerHTML += `
                    <div class="warning-message">
                        Showing first 50 of ${filtered.length.toLocaleString()} stories. 
                        Use filters to narrow results or 
                        <button class="btn" onclick="showAllStories()">Show All Stories</button>
                    </div>
                `;
            }
        }

        function openStory(url) {
            if (url && url !== '#' && !url.includes('example.com')) {
                window.open(url, '_blank');
            }
        }

        function showAllStories() {
            // Implementation for showing all stories with virtual scrolling
            showSuccess('Virtual scrolling for large datasets - feature available in full version');
        }

        // Chart Rendering Functions
        function renderCharts() {
            renderTrendsChart();
            renderGeoChart();
            renderTypesChart();
            renderFlagsChart();
            renderFinancialChart();
            renderEntityChart();
            renderCorrelationChart();
            renderHeatmap();
        }

        function renderTrendsChart() {
            const ctx = document.getElementById('trendsChart');
            if (!ctx) return;
            const ctxChart = ctx.getContext('2d');
            if (charts.trends) charts.trends.destroy();

            const weeklyData = {};
            storyArr.forEach(story => {
                const date = new Date(story.date);
                const weekStart = new Date(date.getFullYear(), date.getMonth(), date.getDate() - date.getDay());
                const weekKey = weekStart.toISOString().substring(0, 10);
                
                if (!weeklyData[weekKey]) {
                    weeklyData[weekKey] = { total: 0, high: 0, medium: 0, low: 0 };
                }
                weeklyData[weekKey].total++;
                weeklyData[weekKey][story.severity.toLowerCase()]++;
            });

            const sortedWeeks = Object.keys(weeklyData).sort().slice(-12); // Last 12 weeks

            charts.trends = new Chart(ctxChart, {
                type: 'line',
                data: {
                    labels: sortedWeeks.map(week => new Date(week).toLocaleDateString()),
                    datasets: [{
                        label: 'High Risk',
                        data: sortedWeeks.map(week => weeklyData[week]?.high || 0),
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Medium Risk',
                        data: sortedWeeks.map(week => weeklyData[week]?.medium || 0),
                        borderColor: '#f39c12',
                        backgroundColor: 'rgba(243, 156, 18, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Low Risk',
                        data: sortedWeeks.map(week => weeklyData[week]?.low || 0),
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Corruption Cases Trend (Weekly)' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function renderGeoChart() {
            const ctx = document.getElementById('geoChart');
            if (!ctx) return;
            const ctxChart = ctx.getContext('2d');
            if (charts.geo) charts.geo.destroy();

            const stateData = {};
            storyArr.forEach(story => {
                if (story.state) {
                    stateData[story.state] = (stateData[story.state] || 0) + 1;
                }
            });

            const sortedStates = Object.entries(stateData)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 15);

            charts.geo = new Chart(ctxChart, {
                type: 'bar',
                data: {
                    labels: sortedStates.map(([state]) => state),
                    datasets: [{
                        label: 'Cases by State',
                        data: sortedStates.map(([,count]) => count),
                        backgroundColor: 'rgba(52, 152, 219, 0.8)',
                        borderColor: '#3498db',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Top 15 States by Case Count' }
                    },
                    scales: { y: { beginAtZero: true } },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const state = sortedStates[index][0];
                            filterByState(state);
                        }
                    }
                }
            });
        }

        function renderTypesChart() {
            const ctx = document.getElementById('typesChart');
            if (!ctx) return;
            const ctxChart = ctx.getContext('2d');
            if (charts.types) charts.types.destroy();

            const typeData = {};
            storyArr.forEach(story => {
                const type = story.subtype || story.type;
                typeData[type] = (typeData[type] || 0) + 1;
            });

            const colors = [
                '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6',
                '#1abc9c', '#34495e', '#e67e22', '#95a5a6', '#f1c40f'
            ];

            charts.types = new Chart(ctxChart, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(typeData),
                    datasets: [{
                        data: Object.values(typeData),
                        backgroundColor: colors.slice(0, Object.keys(typeData).length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        title: { display: true, text: 'Corruption Types Distribution' }
                    }
                }
            });
        }

        function renderFlagsChart() {
            const ctx = document.getElementById('flagsChart');
            if (!ctx) return;
            const ctxChart = ctx.getContext('2d');
            if (charts.flags) charts.flags.destroy();

            const flagData = {};
            storyArr.forEach(story => {
                if (story.flags && Array.isArray(story.flags)) {
                    story.flags.forEach(flag => {
                        flagData[flag] = (flagData[flag] || 0) + 1;
                    });
                }
            });

            const sortedFlags = Object.entries(flagData)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);

            if (sortedFlags.length === 0) {
                sortedFlags.push(['No flags detected', 0]);
            }

            charts.flags = new Chart(ctxChart, {
                type: 'bar',
                data: {
                    labels: sortedFlags.map(([flag]) => flag),
                    datasets: [{
                        label: 'Red Flag Frequency',
                        data: sortedFlags.map(([,count]) => count),
                        backgroundColor: 'rgba(231, 76, 60, 0.8)',
                        borderColor: '#e74c3c',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Most Common Red Flags' }
                    },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function renderFinancialChart() {
            const ctx = document.getElementById('financialChart');
            if (!ctx) return;
            const ctxChart = ctx.getContext('2d');
            if (charts.financial) charts.financial.destroy();

            const monthlyFinancial = {};
            storyArr.filter(s => s.amount).forEach(story => {
                const month = new Date(story.date).toISOString().substring(0, 7);
                monthlyFinancial[month] = (monthlyFinancial[month] || 0) + story.amount;
            });

            const sortedMonths = Object.keys(monthlyFinancial).sort().slice(-12);

            charts.financial = new Chart(ctxChart, {
                type: 'bar',
                data: {
                    labels: sortedMonths.map(month => 
                        new Date(month + '-01').toLocaleDateString('en-US', { year: 'numeric', month: 'short' })
                    ),
                    datasets: [{
                        label: 'Financial Impact ($)',
                        data: sortedMonths.map(month => monthlyFinancial[month] || 0),
                        backgroundColor: 'rgba(52, 152, 219, 0.8)',
                        borderColor: '#3498db',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Monthly Financial Impact' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return ' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderEntityChart() {
            const ctx = document.getElementById('entityChart');
            if (!ctx) return;
            const ctxChart = ctx.getContext('2d');
            if (charts.entity) charts.entity.destroy();

            const entityCounts = { persons: 0, organizations: 0, amounts: 0 };
            storyArr.forEach(story => {
                if (story.entities) {
                    entityCounts.persons += (story.entities.persons && Array.isArray(story.entities.persons)) ? story.entities.persons.length : 0;
                    entityCounts.organizations += (story.entities.organizations && Array.isArray(story.entities.organizations)) ? story.entities.organizations.length : 0;
                    entityCounts.amounts += (story.entities.amounts && Array.isArray(story.entities.amounts)) ? story.entities.amounts.length : 0;
                }
            });

            charts.entity = new Chart(ctxChart, {
                type: 'doughnut',
                data: {
                    labels: ['Officials & Persons', 'Organizations', 'Financial Amounts'],
                    datasets: [{
                        data: [entityCounts.persons, entityCounts.organizations, entityCounts.amounts],
                        backgroundColor: ['#3498db', '#9b59b6', '#e67e22'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        title: { display: true, text: 'Extracted Entities' }
                    }
                }
            });
        }

        function renderCorrelationChart() {
            const ctx = document.getElementById('correlationChart');
            if (!ctx) return;
            const ctxChart = ctx.getContext('2d');
            if (charts.correlation) charts.correlation.destroy();

            const stateRiskData = {};
            storyArr.forEach(story => {
                if (story.state) {
                    if (!stateRiskData[story.state]) {
                        stateRiskData[story.state] = { riskSum: 0, count: 0, amounts: [] };
                    }
                    stateRiskData[story.state].riskSum += story.riskScore;
                    stateRiskData[story.state].count++;
                    if (story.amount) stateRiskData[story.state].amounts.push(story.amount);
                }
            });

            const scatterData = Object.entries(stateRiskData).map(([state, data]) => ({
                x: data.riskSum / data.count,
                y: data.amounts.length > 0 ? data.amounts.reduce((a, b) => a + b, 0) / data.amounts.length : 0,
                state: state
            })).filter(d => d.y > 0);

            charts.correlation = new Chart(ctxChart, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Risk vs Financial Impact by State',
                        data: scatterData,
                        backgroundColor: 'rgba(231, 76, 60, 0.6)',
                        borderColor: '#e74c3c',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Risk Score vs Financial Impact Correlation' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = scatterData[context.dataIndex];
                                    return `${point.state}: Risk ${context.parsed.x.toFixed(1)}, Impact ${(context.parsed.y/1000000).toFixed(1)}M`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Average Risk Score' } },
                        y: {
                            title: { display: true, text: 'Average Financial Impact ($)' },
                            ticks: {
                                callback: function(value) {
                                    return ' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderHeatmap() {
            const container = document.getElementById('heatmapContainer');
            if (!container) return;

            const stateRisk = {};
            storyArr.forEach(story => {
                if (story.state) {
                    if (!stateRisk[story.state]) stateRisk[story.state] = [];
                    stateRisk[story.state].push(story.riskScore);
                }
            });

            const avgRisk = {};
            Object.entries(stateRisk).forEach(([state, risks]) => {
                avgRisk[state] = risks.reduce((a, b) => a + b, 0) / risks.length;
            });

            const states = [
                'AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE', 'FL', 'GA', 'HI', 'ID', 'IL', 'IN', 'IA',
                'KS', 'KY', 'LA', 'ME', 'MD', 'MA', 'MI', 'MN', 'MS', 'MO', 'MT', 'NE', 'NV', 'NH', 'NJ', 
                'NM', 'NY', 'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC', 'SD', 'TN', 'TX', 'UT', 'VT', 
                'VA', 'WA', 'WV', 'WI', 'WY'
            ];

            let heatmapHtml = '<div style="display: flex; flex-wrap: wrap; gap: 2px; justify-content: center;">';
            states.forEach(state => {
                const risk = avgRisk[state] || 0;
                const intensity = Math.min(risk / 100, 1);
                const color = `rgba(231, 76, 60, ${intensity})`;
                heatmapHtml += `
                    <div class="state-cell"
                         style="background-color: ${color}; border: 1px solid #ddd;"
                         title="${state}: ${risk.toFixed(1)} risk score"
                         onclick="filterByState('${state}')">
                        ${state}
                    </div>
                `;
            });
            heatmapHtml += '</div>';
            heatmapHtml += '<div style="margin-top: 10px; text-align: center; font-size: 0.8rem; color: #7f8c8d;">Click state to filter ‚Ä¢ Darker = Higher Risk</div>';

            container.innerHTML = heatmapHtml;
        }

        function filterByState(state) {
            document.getElementById('stateFilter').value = state;
            refreshAll();
        }

        function populateStateFilter() {
            const stateFilter = document.getElementById('stateFilter');
            const states = new Set(storyArr.map(s => s.state).filter(Boolean));
            const sortedStates = Array.from(states).sort();
            stateFilter.innerHTML = '<option value="*">All States</option>' +
                sortedStates.map(state => `<option value="${state}">${state}</option>`).join('');
        }

        function refreshAll() {
            updateStats();
            renderStories();
            renderCharts();
            populateStateFilter();
            updateAIInsights();
        }

        // Network Graph Functions
        function generateNetwork() {
            const networkGraph = document.getElementById('networkGraph');
            
            const nodes = new Map();
            storyArr.forEach(story => {
                if (story.entities && story.entities.persons && Array.isArray(story.entities.persons)) {
                    story.entities.persons.forEach(person => {
                        const nodeId = person.name || 'Unknown';
                        if (!nodes.has(nodeId)) {
                            nodes.set(nodeId, {
                                id: nodeId,
                                label: person.name || 'Unknown',
                                title: person.title || 'Official',
                                type: 'person',
                                stories: []
                            });
                        }
                        nodes.get(nodeId).stories.push(story.id);
                    });
                }

                if (story.entities && story.entities.organizations && Array.isArray(story.entities.organizations)) {
                    story.entities.organizations.forEach(org => {
                        const nodeId = org;
                        if (!nodes.has(nodeId)) {
                            nodes.set(nodeId, {
                                id: nodeId,
                                label: org,
                                type: 'organization',
                                stories: []
                            });
                        }
                        nodes.get(nodeId).stories.push(story.id);
                    });
                }
            });

            let networkHtml = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3>Political Influence Network</h3>
                    <p>${nodes.size.toLocaleString()} entities connected across ${storyArr.length.toLocaleString()} corruption cases</p>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; max-height: 400px; overflow-y: auto;">
            `;

            Array.from(nodes.values())
                .sort((a, b) => b.stories.length - a.stories.length)
                .slice(0, 50)
                .forEach(node => {
                    const connectionCount = node.stories.length;
                    const nodeSize = Math.min(connectionCount * 2 + 10, 40);
                    const nodeColor = node.type === 'person' ? '#3498db' : '#e67e22';
                    networkHtml += `
                        <div class="network-node"
                             onclick="showNodeDetails('${node.id}')">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: ${nodeSize}px; height: ${nodeSize}px; background: ${nodeColor}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8rem;">
                                    ${node.type === 'person' ? 'üë§' : 'üè¢'}
                                </div>
                                <div>
                                    <div style="font-weight: bold; font-size: 0.9rem;">${node.label}</div>
                                    <div style="font-size: 0.7rem; color: #7f8c8d;">${connectionCount} connections</div>
                                    ${node.title && node.title !== 'Official' ? `<div style="font-size: 0.7rem; color: #3498db;">${node.title}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });

            networkHtml += '</div>';
            if (nodes.size > 50) {
                networkHtml += `<div style="text-align: center; margin-top: 15px; color: #7f8c8d;">Showing top 50 most connected entities. ${(nodes.size - 50).toLocaleString()} more available.</div>`;
            }

            networkGraph.innerHTML = networkHtml;
        }

        function showNodeDetails(nodeId) {
            showSuccess(`Node analysis for: ${nodeId} - Feature available in full version with detailed relationship mapping`);
        }

        // Newsletter Functions
        function setupNewsletterDropZone() {
            const dropZone = document.getElementById('newsletterContent');
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const storyData = e.dataTransfer.getData('text/plain');
                if (storyData) {
                    try {
                        const story = JSON.parse(storyData);
                        addToNewsletter(story);
                    } catch (error) {
                        showError('Invalid story data');
                    }
                }
            });
        }

        function handleDragStart(event) {
            event.dataTransfer.setData('text/plain', event.target.dataset.story);
        }

        function addToNewsletter(story) {
            const content = document.getElementById('newsletterContent');
            const existingItems = content.querySelectorAll('.newsletter-item');

            for (let item of existingItems) {
                if (item.dataset.storyId === story.id) {
                    return;
                }
            }

            if (existingItems.length === 0) {
                content.innerHTML = '';
            }

            const item = document.createElement('div');
            item.className = 'newsletter-item';
            item.dataset.storyId = story.id;
            item.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; gap: 15px;">
                    <div style="flex: 1;">
                        <strong>${story.headline}</strong><br>
                        <small style="color: #7f8c8d;">${story.state || 'Unknown'} ‚Ä¢ ${new Date(story.date).toLocaleDateString()} ‚Ä¢ Risk: ${story.riskScore}/100</small><br>
                        <p style="margin: 8px 0; line-height: 1.4;">${story.summary}</p>
                        ${story.amount ? `<span style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8em;">${story.amount.toLocaleString()}</span>` : ''}
                        ${story.flags && story.flags.length ? `<div style="margin-top: 8px;">${story.flags.map(flag => `<span style="background: #fadbd8; color: #e74c3c; padding: 2px 6px; border-radius: 8px; font-size: 0.7em; margin-right: 5px;">üö© ${flag}</span>`).join('')}</div>` : ''}
                    </div>
                    <button onclick="removeFromNewsletter('${story.id}')" style="background: #e74c3c; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px;">√ó</button>
                </div>
            `;
            content.appendChild(item);
        }

        function removeFromNewsletter(storyId) {
            const item = document.querySelector(`[data-story-id="${storyId}"]`);
            if (item) {
                item.remove();
            }
            const content = document.getElementById('newsletterContent');
            if (content.children.length === 0) {
                content.innerHTML = '<p style="color: #7f8c8d; text-align: center; font-size: 1.1rem;">üéØ Drag corruption stories here to build your newsletter<br><small>Supports drag-and-drop from the stories list</small></p>';
            }
        }

        function clearNewsletter() {
            const content = document.getElementById('newsletterContent');
            content.innerHTML = '<p style="color: #7f8c8d; text-align: center; font-size: 1.1rem;">üéØ Drag corruption stories here to build your newsletter<br><small>Supports drag-and-drop from the stories list</small></p>';
        }

        function loadTemplate(type) {
            const content = document.getElementById('newsletterContent');
            const date = new Date().toLocaleDateString();
            let templateContent = '';

            switch (type) {
                case 'weekly':
                    templateContent = `
                        <div class="newsletter-item">
                            <h2>üìÖ Weekly Corruption Roundup - ${date}</h2>
                            <p>This week's most significant corruption cases across the United States...</p>
                        </div>
                    `;
                    break;
                case 'breaking':
                    templateContent = `
                        <div class="newsletter-item">
                            <h2>‚ö° Breaking Corruption Alert - ${date}</h2>
                            <p>Urgent corruption developments requiring immediate attention...</p>
                        </div>
                    `;
                    break;
                case 'investigation':
                    templateContent = `
                        <div class="newsletter-item">
                            <h2>üîç Deep Dive Investigation - ${date}</h2>
                            <p>Comprehensive analysis of corruption patterns and connections...</p>
                        </div>
                    `;
                    break;
                case 'analysis':
                    templateContent = `
                        <div class="newsletter-item">
                            <h2>üìä Monthly Corruption Analysis - ${date}</h2>
                            <p>Statistical trends and predictive insights for corruption monitoring...</p>
                        </div>
                    `;
                    break;
            }
            content.innerHTML = templateContent;
        }

        function exportNewsletter(format) {
            const content = document.getElementById('newsletterContent');
            const items = content.querySelectorAll('.newsletter-item');

            if (items.length === 0) {
                showError('Newsletter is empty! Add some corruption stories first by dragging them from the stories list.');
                return;
            }

            const title = document.getElementById('newsletterTitle').value || 'Corruption Newsletter';
            const author = document.getElementById('authorName').value || 'Corruption Tracker';
            const date = new Date().toLocaleDateString();

            if (format === 'html') {
                const html = generateNewsletterHTML(title, author, date, items);
                downloadFile(html, `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_${date.replace(/\//g, '_')}.html`, 'text/html');
            } else if (format === 'pdf') {
                showSuccess('PDF export - Feature available in full version with proper PDF generation');
            } else if (format === 'google') {
                showSuccess('Google Docs integration - Feature available in full version with Google Drive API');
            }
        }

        function generateNewsletterHTML(title, author, date, items) {
            let content = '';
            items.forEach(item => {
                content += `<div style="margin-bottom: 25px; padding: 20px; border-left: 5px solid #3498db; background: white; border-radius: 10px;">${item.innerHTML}</div>`;
            });

            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>${title} - ${date}</title>
                    <style>
                        body { font-family: 'Segoe UI', Arial, sans-serif; max-width: 700px; margin: 0 auto; padding: 30px; background: #f8f9fa; }
                        .header { background: linear-gradient(135deg, #2c3e50, #34495e); color: white; padding: 30px; border-radius: 15px; text-align: center; margin-bottom: 30px; }
                        .footer { text-align: center; color: #7f8c8d; margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>${title}</h1>
                        <p>By ${author} ‚Ä¢ ${date}</p>
                    </div>
                    ${content}
                    <div class="footer">
                        <p>Generated by Corruption Tracker Pro</p>
                        <p>Advanced Government Transparency Platform</p>
                    </div>
                </body></html>
            `;
        }

        // Data Management Functions
        async function exportData() {
            if (storyArr.length === 0) {
                showError('No data to export! Please pull data sources first.');
                return;
            }

            const exportData = storyArr.map(story => ({
                headline: story.headline,
                url: story.url,
                summary: story.summary,
                date: story.date,
                state: story.state,
                type: story.type,
                subtype: story.subtype,
                amount: story.amount,
                parties: story.parties ? story.parties.join('; ') : '',
                flags: story.flags ? story.flags.join('; ') : '',
                severity: story.severity,
                riskScore: story.riskScore,
                source: story.source
            }));

            const headers = Object.keys(exportData[0]);
            const csvContent = [
                headers.join(','),
                ...exportData.map(row =>
                    headers.map(header => {
                        const value = row[header] || '';
                        return typeof value === 'string' ? `"${value.replace(/"/g, '""')}"` : value;
                    }).join(',')
                )
            ].join('\n');

            downloadFile(csvContent, `corruption_data_export_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
            showSuccess(`Exported ${exportData.length.toLocaleString()} corruption cases to CSV file!`);
        }

        async function exportAllData() {
            const allData = {
                stories: storyArr,
                settings: await db.settings.toArray(),
                timestamp: new Date().toISOString(),
                version: CONFIG.VERSION
            };
            
            const json = JSON.stringify(allData, null, 2);
            downloadFile(json, `corruption_tracker_backup_${new Date().toISOString().split('T')[0]}.json`, 'application/json');
            showSuccess('Complete database backup exported successfully!');
        }

        function importData() {
            document.getElementById('fileInput').click();
        }

        async function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                if (data.stories && Array.isArray(data.stories)) {
                    await db.stories.clear();
                    await db.stories.bulkAdd(data.stories);
                    storyArr.splice(0, storyArr.length, ...data.stories);
                    refreshAll();
                    showSuccess(`Imported ${data.stories.length.toLocaleString()} stories successfully!`);
                } else {
                    showError('Invalid data format. Expected JSON with stories array.');
                }
            } catch (error) {
                showError('Failed to import data: ' + error.message);
            }
        }

        async function createBackup() {
            const backup = {
                stories: await db.stories.toArray(),
                settings: await db.settings.toArray(),
                cache: await db.cache.toArray(),
                timestamp: new Date().toISOString(),
                version: CONFIG.VERSION
            };
            
            await db.exports.add({
                name: `Backup_${new Date().toISOString().split('T')[0]}`,
                data: backup,
                timestamp: Date.now()
            });
            
            showSuccess('Backup created and stored locally!');
            updateDataManagerTab();
        }

        async function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                await db.stories.clear();
                await db.cache.clear();
                await db.logs.clear();
                storyArr.splice(0, storyArr.length);
                refreshAll();
                showSuccess('All data cleared successfully!');
                updateDataManagerTab();
            }
        }

        // Utility Functions
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showSuccess(message) {
            showNotification(message, 'success');
        }

        function showError(message) {
            showNotification(message, 'error');
        }

        function showWarning(message) {
            showNotification(message, 'warning');
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `${type}-message`;
            notification.innerHTML = message;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '10000';
            notification.style.maxWidth = '400px';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        function toggleOfflineMode(enabled) {
            isOfflineMode = enabled !== undefined ? enabled : !isOfflineMode;
            const text = document.getElementById('offlineModeText');
            if (text) {
                text.textContent = isOfflineMode ? 'üì¥ Offline' : 'üì∂ Online';
            }
            updateSystemStatus(isOfflineMode ? 'offline' : 'online');
        }

        function toggleDarkMode(enabled) {
            document.body.classList.toggle('dark-theme', enabled);
        }

        function resetToDefaults() {
            if (confirm('Reset all settings to defaults?')) {
                db.settings.clear();
                showSuccess('Settings reset to defaults. Reload the page to apply changes.');
            }
        }

        async function clearCache() {
            await db.cache.clear();
            showSuccess('Cache cleared successfully!');
            dataManager.updateCacheInfo('0.00');
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            setupNewsletterDropZone();
        });

        // Handle hash navigation
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.substring(1);
            if (hash && document.getElementById(hash)) {
                showTab(hash);
            }
        });

        // Handle PWA install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });

        // Performance monitoring
        window.addEventListener('load', () => {
            if ('performance' in window) {
                const perfData = performance.getEntriesByType('navigation')[0];
                console.log(`App loaded in ${perfData.loadEventEnd - perfData.loadEventStart}ms`);
            }
        });

        // Error handling
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
            db.logs.add({
                level: 'error',
                message: e.error.message,
                timestamp: Date.now()
            });
        });

        // Expose global functions for HTML onclick events
        window.showTab = showTab;
        window.generateNetwork = generateNetwork;
        window.exportNewsletter = exportNewsletter;
        window.clearNewsletter = clearNewsletter;
        window.loadTemplate = loadTemplate;
        window.exportData = exportData;
        window.exportAllData = exportAllData;
        window.importData = importData;
        window.handleFileImport = handleFileImport;
        window.createBackup = createBackup;
        window.clearAllData = clearAllData;
        window.resetToDefaults = resetToDefaults;
        window.clearCache = clearCache;
        window.toggleOfflineMode = toggleOfflineMode;
        window.filterByState = filterByState;
        window.showNodeDetails = showNodeDetails;
        window.openStory = openStory;
        window.showAllStories = showAllStories;
        window.handleDragStart = handleDragStart;
        window.removeFromNewsletter = removeFromNewsletter;
    </script>
</body>
</html>
